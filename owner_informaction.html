<script>
    
    function validateDate(value) {
        if (value.length !== 10) return;
        const [mm, dd, yyyy] = value.split("/").map(Number);
        const currentYear = new Date().getFullYear();
        if (mm < 1 || mm > 12) {
            return false;
        }
        if (yyyy < 1900 || yyyy > currentYear) {
            return false;
        }
        const daysInMonth = new Date(yyyy, mm, 0).getDate();
        if (dd < 1 || dd > daysInMonth) {
            return false;
        }
        return true;
    }

    function validateSSN(value) {
        if (value.length !== 11) return;
        const [area, group, serial] = value.split("-");
        if (area === "000" || area === "666" || area.startsWith("9")) {
            return false;
        }
        if (group === "00") {
            return false;
        }
        if (serial === "0000") {
            return false;
        }
        return true;
    }

    document.addEventListener("DOMContentLoaded", function () {
        var owner_inform = document.querySelector('form[name="owner_inform"]');
        if (!owner_inform) return;
        // zip code
        var zipInput = owner_inform.querySelector('#form-field-owner_zip');
        if (!zipInput) return;
        zipInput.maxLength = 5;
        zipInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, ''); // remove non-digits
        });
        // ownership start date
        var ownerBirthInput = owner_inform.querySelector('#form-field-owner_birth');
        if (!ownerBirthInput) return;
        ownerBirthInput.maxLength = 10;
        ownerBirthInput.addEventListener('input', function() {
            var value = ownerBirthInput.value.replace(/\D/g, ""); // numbers only
            if (value.length > 8) value = value.slice(0, 8);
            if (value.length >= 5) {
                value = value.replace(/^(\d{2})(\d{2})(\d{0,4})$/, "$1/$2/$3");
            } else if (value.length >= 3) {
                value = value.replace(/^(\d{2})(\d{0,2})$/, "$1/$2");
            }

            if (!validateDate(value)) {
                ownerBirthInput.setCustomValidity('Please enter a valid date of birth');
                ownerBirthInput.reportValidity();
            }else{
                ownerBirthInput.setCustomValidity('');
            }
            ownerBirthInput.value = value;
        });

        // ssn
        var ssnInput = owner_inform.querySelector('#form-field-owner_ssn');
        if (!ssnInput) return;
        ssnInput.maxLength = 11;
        ssnInput.addEventListener("focus", () => {
            ssnInput.type = "text";
        });
        
        ssnInput.addEventListener("input", () => {
            ssnInput.type = "text";
            var value = ssnInput.value.replace(/\D/g, ""); // numbers only
            if (value.length > 9) value = value.slice(0, 9);
            if (value.length >= 6) {
                value = value.replace(/^(\d{3})(\d{2})(\d{0,4})$/, "$1-$2-$3");
            } else if (value.length >= 4) {
                value = value.replace(/^(\d{3})(\d{0,2})$/, "$1-$2");
            }
            if (!validateSSN(value)) {
                ssnInput.setCustomValidity('Please enter your SSN');
                ssnInput.reportValidity();
            }else{
                ssnInput.setCustomValidity('');
            }
            ssnInput.value = value;
        });
        
        ssnInput.addEventListener("blur", () => {
            if (ssnInput.value) ssnInput.type = "password";
        });
        
        // terms and conditions
        var termsCheckbox = owner_inform.querySelector('#form-field-check_terms-0');
        if (!termsCheckbox) return;
        termsCheckbox.checked = true;

        // submit
        owner_inform.addEventListener("submit", function(event) {
            event.preventDefault();
            var formData = new FormData(this);
            setTimeout(() => {
                //owner_inform.reset();
                history.pushState(null, '', '/apply/?identity-verification');
                var step = window.location.search.replace("?", "");
                applyToStep(step);
            }, 1500);
        });
    });
</script>